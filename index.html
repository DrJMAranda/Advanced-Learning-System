<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Learning Systems - ONETH LGC</title>
    
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;700&display=swap" rel="stylesheet">
    
    <style id="consolidated-css-style">
        /* General Body Styles */
        body {
            font-family: 'EB Garamond', serif;
            line-height: 1.6;
            padding: 0;
            margin: 0;
            background-color: #f4f4f4;
            display: flex;
            height: 100vh;
        }

        /* Main Content Area (Vertical Scrollable Index) */
        .main-container {
            flex: 1;
            padding: 10px;
            overflow-y: auto; /* Primary vertical scroll */
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Fixed Menu Container (Sidebar) */
        .fixed-menu-container {
            width: 250px;
            padding: 10px;
            background-color: #e9ecef;
            border-left: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 0.9em;
        }

        /* Fixed Menu List */
        .fixed-menu-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        /* Fixed Menu Items */
        .fixed-menu-item a {
            text-decoration: none;
            color: #000;
            font-size: .9em;
            font-weight: bold;
            display: block;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        /* Fixed Menu Header */
        .fixed-menu-header {
            display: flex;
            flex-direction: column; /* Changed for better stacking */
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        /* Fixed Menu Header Title */
        .fixed-menu-header h3 {
            font-size: 1.2em;
            margin: 0;
        }

        /* Powered by Gemini Text */
        .powered-by-gemini {
            font-size: 0.8em;
            color: #6c757d;
        }

        /* Credits Box */
        .credits-box {
            font-size: 0.5em;
            color: #6c757d;
            text-align: center;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }

        /* Table of Contents Grid for a compact icon layout */
        .toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(1in, 1fr));
            gap: 10px;
            padding: 10px;
            justify-content: center;
        }

        /* New styling for the small icons */
        .content-icon {
            width: 1in;
            height: auto;
            display: block;
            margin: 0 auto;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* --- PHASE D/G/I: FIXED MEDIA CONTAINER & ELEMENTS --- */
        #fixed-media-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); /* Near-black overlay */
            z-index: 1000; /* Below the control bar */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .hidden {
            display: none !important;
        }

        #media-title {
            color: white;
            position: absolute;
            top: 10px;
            font-size: 1.5em;
            z-index: 1001;
        }

        /* Video Player Styling */
        #landscape-video {
            max-width: 90%;
            max-height: 80vh;
            height: auto;
        }

        /* Static Image/PDF Viewer Styling */
        #static-image-viewer {
            max-width: 90%;
            max-height: 80vh;
            height: 100%;
            overflow-y: auto; /* Allows scrolling of large images/PDFs */
            background-color: white;
            position: relative;
        }

        /* --- PHASE B/C: CONTROL BAR STYLES (Bottom Fixed) --- */
        #horizontal-icon-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1002; /* PHASE K: Highest Z-index for controls */
        }

        #horizontal-icon-bar button {
            padding: 10px 15px;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        #horizontal-icon-bar button:hover {
            background-color: #777;
        }

        /* --- CSS Phase N: SHUTDOWN COUNTDOWN --- */
        #shutdown-countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Centers the element */
            
            background-color: rgba(255, 0, 0, 0.9); /* Semi-transparent Red */
            color: white;
            font-size: 32px;
            font-weight: bold;
            padding: 15px 30px;
            border-radius: 8px;
            
            z-index: 10000; /* Highest Z-Index to overlap everything during shutdown */
        }
    </style>
</head>
<body>

    <div class="main-container" id="lesson-index-list">
        <div class="toc-grid">
            <a href="#" class="media-activator-icon" data-lesson-title="Lesson 1: Addition" data-path="video/add.mp4" data-type="video">
                <img src="https://storage.googleapis.com/noenbalde/Car%C3%A1tulas/The%20Journey%20Begins.jpg" alt="The Journey Begins Icon" class="content-icon" title="Lesson 1: Addition (Video)">
            </a>
            <a href="#" class="media-activator-icon" data-lesson-title="Lesson 2: Subtraction" data-path="image/sub.pdf" data-type="image">
                <img src="https://storage.googleapis.com/noenbalde/Car%C3%A1tulas/Mr.%20Zero%2C%20The%20First%20Something.jpg" alt="Mr. Zero Icon" class="content-icon" title="Lesson 2: Subtraction (Image/PDF)">
            </a>
            <a href="#" class="media-activator-icon" data-lesson-title="Lesson 3: Multiplication" data-path="video/mul.mp4" data-type="video">
                <img src="https://storage.googleapis.com/noenbalde/Car%C3%A1tulas/The%20Numeral%20Family.jpg" alt="The Numeral Family Icon" class="content-icon" title="Lesson 3: Multiplication (Video)">
            </a>
            <div id="next-row-container"></div>
        </div>
    </div>

    <div class="fixed-menu-container">
        <div class="fixed-menu-header">
            <h3>Advanced Learning Systems</h3>
            <p class="powered-by-gemini">Powered by Google Gemini</p>
        </div>
        
        <div id="user-identity-status" style="margin-bottom: 10px; font-weight: bold; color: #FFD700;">Status: Offline | ID: Guest</div>
        
        <div style="flex-grow: 1; overflow-y: auto;" id="next-row-scroller">
            <ul class="fixed-menu-list">
                <li class="fixed-menu-item"><a href="#">1. Arithmetic 1</a></li>
                <li class="fixed-menu-item"><a href="#">1a. G1: Numerals through Rational Numbers</a></li>
                <li class="fixed-menu-item"><a href="#">1a1. The Journey Begins...</a></li>
                <li class="fixed-menu-item"><a href="#">1a2. Mr Zero: The First Something!</a></li>
                <li class="fixed-menu-item"><a href="#">1a3. The Numeral Family.</a></li>
                <li class="fixed-menu-item"><a href="#">2. Numbers to |99|</a></li>
                <li class="fixed-menu-item"><a href="#">3. |Decillions|</a></li>
                <li class="fixed-menu-item"><a href="#">4. G2: Arithmetic thru G8</a></li>
                <li class="fixed-menu-item"><a href="#">5. G3: Algebra 1</a></li>
            </ul>
        </div>
        
        <div class="credits-box">
            <p>ONETH LGC: Phase O (Integrity Logging) Secured</p>
        </div>
    </div>

    <div id="fixed-media-container" class="hidden">
        
        <div id="shutdown-countdown" class="hidden">
            Shutting Down in 3...
        </div>

        <h3 id="media-title"></h3>
        
        <video id="landscape-video" class="hidden" controls preload="auto"></video>
        <div id="static-image-viewer" class="hidden">
            </div>

        <div id="horizontal-icon-bar">
            <button id="return-menu-btn" title="Return to Menu">üè† Menu</button>
            <button id="toggle-view-btn" title="Toggle Page View">üîÑ View</button>
            <button id="rewind-btn" title="Rewind 10s">‚è™ Rewind</button>
            <button id="play-pause-btn" title="Play/Pause">‚ñ∂Ô∏è Play</button>
            <button id="ff-btn" title="Fast Forward 10s">‚è© F.F.</button>
            <button id="stop-btn" title="Stop and Close Player">‚óºÔ∏è Stop</button>
            
            <button id="place-marker-btn" title="Save/Load Place Marker" class="marker-btn">üìå Save Marker</button>
        </div>
    </div>
    
    <script id="consolidated-js-script">
        // =================================================================
        // LAST GOOD CODE (LGC) - PHASE O: Operational Integrity Logging
        // Secured against unannounced system shutdown (ONETH Compliance)
        // =================================================================

        // 1. GLOBAL CONSTANTS
        const API_BASE_URL = 'https://api.google-assigned-server.com/v1/user/';
        const API_HEADERS = {
            'Content-Type': 'application/json',
        };

        // 2. DOM REFERENCES
        const lessonIndexList = document.getElementById('lesson-index-list');
        const container = document.getElementById('fixed-media-container');
        const videoPlayer = document.getElementById('landscape-video');
        const staticImage = document.getElementById('static-image-viewer');
        const titleDisplay = document.getElementById('media-title');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const rewindBtn = document.getElementById('rewind-btn');
        const ffBtn = document.getElementById('ff-btn');
        const stopBtn = document.getElementById('stop-btn');
        const toggleViewBtn = document.getElementById('toggle-view-btn');
        const returnMenuBtn = document.getElementById('return-menu-btn');
        const placeMarkerBtn = document.getElementById('place-marker-btn');
        const userIdStatusDisplay = document.getElementById('user-identity-status'); 

        // 3. GLOBAL STATE VARIABLES
        let currentUserId = 'Guest';
        let isOnline = false;
        let currentViewMode = 'default'; // 'default' (landscape) or 'page-width' (PDF)
        let isPaused = true;
        let lastMarker = null; // Stores last session state
        let operationalIntegrityLog = []; // PHASE O: The critical log for session history

        // 4. MOCK DATA (For lessons in HTML)
        const arithmeticIndexData = [
            { title: 'Lesson 1: Addition', path: 'video/add.mp4', type: 'video' },
            { title: 'Lesson 2: Subtraction', path: 'image/sub.pdf', type: 'image' },
            { title: 'Lesson 3: Multiplication', path: 'video/mul.mp4', type: 'video' },
            { title: 'Lesson 4: Division', path: 'image/div.pdf', type: 'image' },
            { title: 'Lesson 5: Speed Read Test', path: null, type: 'text' } // Example of a non-media lesson
        ];


        // =================================================================
        // PHASE O/N/L/M: LOGGING, PERSISTENCE, & SHUTDOWN PROTOCOLS
        // =================================================================

        /**
         * PHASE O/Q2: Records a critical event to the Operational Integrity Log.
         */
        function logOperationalEvent(eventDescription) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                time: timestamp,
                user: currentUserId,
                event: eventDescription
            };
            operationalIntegrityLog.push(logEntry);
            console.log(`LOGGED: ${eventDescription}`);
        }

        /**
         * PHASE M/L/Q1: Generates a unique key for marker storage based on the current user ID.
         */
        function getPersistenceKey() {
            return `LGC_MARKER_${currentUserId.toUpperCase()}`;
        }

        /**
         * PHASE M/L: Saves the current state persistently via API (Server Write Simulation).
         * Implements local storage as the ONETH Safety Protocol fallback.
         */
        async function savePlaceMarker(lessonTitle, mediaPath, mediaType) {
            // 1. Construct lastMarker object
            if (!container.classList.contains('hidden')) {
                let playbackTime = videoPlayer.currentTime;
                let scrollPosition = staticImage.scrollTop || 0; 

                lastMarker = {
                    userId: currentUserId,
                    lessonTitle,
                    mediaPath,
                    mediaType,
                    playbackTime: playbackTime,
                    scrollPosition: scrollPosition
                };
            } else {
                lastMarker = {
                    userId: currentUserId,
                    lessonTitle: 'Index Scroll Position',
                    scrollPosition: lessonIndexList.scrollTop,
                    mediaPath: null,
                    mediaType: 'scroll'
                };
            }
            
            // 2. NEW SERVER PERSISTENCE LOGIC (Write Priority)
            try {
                const endpoint = `${API_BASE_URL}${currentUserId}/marker`;
                console.log(`Simulating API PUT/POST to: ${endpoint}`);
                
                const response = await new Promise(resolve => setTimeout(() => resolve({ status: 200 }), 100));

                if (response.status === 200) {
                    alert(`Marker SAVED TO SERVER for: ${lastMarker.lessonTitle}. (User: ${currentUserId})`);
                    logOperationalEvent(`Marker Saved: ${lastMarker.lessonTitle} (API Success)`);
                } else {
                    throw new Error('Server returned non-200 status.');
                }

            } catch (e) {
                console.error("Failed to save marker to server.", e);
                // Fallback to local persistence (ONETH Safety Protocol)
                const key = getPersistenceKey();
                localStorage.setItem(key, JSON.stringify(lastMarker));
                logOperationalEvent(`Marker Saved: ${lastMarker.lessonTitle} (Local Fallback)`);
                alert("Server save failed. Marker saved locally as fallback (ONETH Safety Protocol).");
            }

            // 3. Update button state
            placeMarkerBtn.textContent = 'üìç Load Marker';
            placeMarkerBtn.onclick = loadPlaceMarker;
        }

        /**
         * PHASE M/L: Loads the last saved marker state (Server Read Simulation).
         */
        async function loadPlaceMarker() {
            let retrievedMarker = null;
            const localKey = getPersistenceKey();
            
            // 1. SERVER PERSISTENCE LOGIC (Read Priority)
            try {
                const endpoint = `${API_BASE_URL}${currentUserId}/marker`;
                console.log(`Simulating API GET from: ${endpoint}`);

                const response = await new Promise(resolve => setTimeout(() => resolve({
                    status: 200, 
                    json: async () => JSON.parse(localStorage.getItem(localKey)) // Local storage acts as API proxy
                }), 100));

                if (response.status === 200) {
                    retrievedMarker = await response.json();
                    logOperationalEvent(`Marker Loaded: ${retrievedMarker.lessonTitle} (API Read)`);
                } else {
                    throw new Error('Server returned non-200 status. Using local fallback.');
                }

            } catch (e) {
                console.warn("Failed to retrieve marker from server. Using local fallback.", e);
                // Fallback: Read from the local persistence layer
                const storedData = localStorage.getItem(localKey);
                if (storedData) {
                    retrievedMarker = JSON.parse(storedData);
                    logOperationalEvent(`Marker Loaded: ${retrievedMarker.lessonTitle} (Local Fallback)`);
                }
            }
            
            if (!retrievedMarker || !retrievedMarker.lessonTitle) {
                alert("No marker has been saved for this user.");
                return;
            }

            lastMarker = retrievedMarker; 
            
            // 2. Restore state based on marker
            if (lastMarker.mediaType === 'scroll') {
                lessonIndexList.scrollTop = lastMarker.scrollPosition;
                alert("Index scroll position restored.");
            } else {
                // Find the lesson data to load the player correctly
                const lesson = arithmeticIndexData.find(l => l.lessonTitle === lastMarker.lessonTitle);
                if (lesson) {
                    loadMediaPlayer(lesson.title, lesson.path, lesson.type);
                } else {
                    alert(`Error: Cannot find lesson data for "${lastMarker.lessonTitle}". Loading player, but state may be incomplete.`);
                    loadMediaPlayer(lastMarker.lessonTitle, lastMarker.mediaPath, lastMarker.mediaType);
                }

                
                if (lastMarker.mediaType === 'video') {
                    videoPlayer.currentTime = lastMarker.playbackTime;
                    videoPlayer.pause();
                    isPaused = true;
                    playPauseBtn.textContent = '‚ñ∂Ô∏è Play';
                } else if (lastMarker.mediaType === 'image') {
                    staticImage.scrollTop = lastMarker.scrollPosition;
                }
                alert(`Content restored to: ${lastMarker.lessonTitle}.`);
            }

            // 3. Reset button state
            placeMarkerBtn.textContent = 'üìå Save Marker';
            placeMarkerBtn.onclick = savePlaceMarker;
        }

        /**
         * PHASE N: Executes the immediate player wipe (internal function).
         */
        function _immediateWipe() {
            container.classList.add('hidden');
            videoPlayer.classList.add('hidden');
            staticImage.classList.add('hidden');
            
            videoPlayer.pause();
            videoPlayer.src = '';
            
            playPauseBtn.classList.add('hidden');
            rewindBtn.classList.add('hidden');
            ffBtn.classList.add('hidden');
            stopBtn.classList.add('hidden');
            toggleViewBtn.classList.add('hidden');
            returnMenuBtn.classList.add('hidden');
            placeMarkerBtn.classList.add('hidden');
            
            const countdownDisplay = document.getElementById('shutdown-countdown');
            if (countdownDisplay) {
                countdownDisplay.classList.add('hidden');
            }
            
            playPauseBtn.textContent = '‚ñ∂Ô∏è Play';
            isPaused = true; // Ensure state is reset
            logOperationalEvent("Media Player Wiped (Shutdown Complete)");
        }

        /**
         * PHASE N/O: Initiates the controlled shutdown protocol with GUARANTEED LOCAL BACKUP.
         */
        window.wipePlayer = function() {
            logOperationalEvent("Shutdown Protocol Initiated");
            
            // --- CRITICAL LGC FORTIFICATION: State and Log Backup ---
            // 1. Save lastMarker state
            const markerKey = getPersistenceKey();
            const lastMarkerData = JSON.stringify(lastMarker); 
            if (lastMarkerData && lastMarker) {
                try {
                    localStorage.setItem(markerKey, lastMarkerData);
                    console.log("CRITICAL: Local state backup secured against external shutdown.");
                } catch (e) {
                    console.warn("CRITICAL FAILURE: Marker local backup failed.", e);
                }
            }
            
            // 2. Save the entire Operational Integrity Log
            const logKey = `LGC_O_LOG_${currentUserId.toUpperCase()}`;
            const logData = JSON.stringify(operationalIntegrityLog);
            if (logData) {
                try {
                    localStorage.setItem(logKey, logData);
                    console.log("CRITICAL: Full Operational Log secured against external shutdown.");
                } catch (e) {
                    console.warn("CRITICAL FAILURE: Log backup failed.", e);
                }
            }
            // --------------------------------------------------------
            
            const countdownDisplay = document.getElementById('shutdown-countdown');
            if (container.classList.contains('hidden') || !countdownDisplay) {
                _immediateWipe();
                return;
            }

            // Show and start the countdown
            countdownDisplay.classList.remove('hidden');
            let count = 3;
            
            const intervalId = setInterval(() => {
                if (count > 0) {
                    countdownDisplay.textContent = `Shutting Down in ${count}...`;
                    count--;
                } else {
                    clearInterval(intervalId);
                    _immediateWipe();
                }
            }, 1000); 
        };


        // =================================================================
        // PHASE J/K: IDENTITY FUNCTIONS
        // =================================================================

        /**
         * Updates the User ID and online status display.
         */
        function updateIdentityStatus() {
            if (userIdStatusDisplay) {
                const statusText = isOnline ? 'Online' : 'Offline';
                userIdStatusDisplay.textContent = `Status: ${statusText} | ID: ${currentUserId}`;
                userIdStatusDisplay.style.color = isOnline ? '#00FF00' : '#FFD700'; 
            }
        }

        /**
         * Placeholder for future server/Google login.
         */
        window.simulateLogin = function(id) {
            currentUserId = id;
            isOnline = true;
            updateIdentityStatus();
            console.log(`User logged in: ${id}. System is now online.`);
            logOperationalEvent(`User Authenticated: ${id}`);
            alert(`Welcome, ${id}! System now online.`);
        }

        // =================================================================
        // PHASE A-I: MEDIA PLAYER CONTROL (Core Logic)
        // =================================================================

        /**
         * Loads the media player with content.
         */
        function loadMediaPlayer(title, path, type) {
            logOperationalEvent(`Loading Media: ${title} (${type})`);
            
            // 1. Hide/Show containers
            container.classList.remove('hidden');
            lessonIndexList.scrollTop = 0; // Reset main scroll
            
            // 2. Set title
            titleDisplay.textContent = title;

            // 3. Media specific logic
            if (type === 'video') {
                videoPlayer.src = path;
                videoPlayer.classList.remove('hidden');
                staticImage.classList.add('hidden');
                isPaused = true;
                playPauseBtn.textContent = '‚ñ∂Ô∏è Play';
            } else if (type === 'image') {
                // In a real app, this would load a PDF viewer or a large image
                staticImage.innerHTML = `<img src="https://via.placeholder.com/1000x2000?text=${title.replace(/ /g, '+')}" alt="${title}" style="width: 100%; height: auto;">`;
                staticImage.classList.remove('hidden');
                videoPlayer.classList.add('hidden');
            }
            
            // 4. Show controls
            playPauseBtn.classList.remove('hidden');
            rewindBtn.classList.remove('hidden');
            ffBtn.classList.remove('hidden');
            stopBtn.classList.remove('hidden');
            toggleViewBtn.classList.remove('hidden');
            returnMenuBtn.classList.remove('hidden');
            placeMarkerBtn.classList.remove('hidden');
            
            // 5. Setup initial marker state
            placeMarkerBtn.textContent = 'üìå Save Marker';
            placeMarkerBtn.onclick = savePlaceMarker;
        }


        /**
         * Toggles the media playback state.
         */
        function togglePlayPause() {
            if (videoPlayer.classList.contains('hidden')) return; // Only for video
            
            if (isPaused) {
                videoPlayer.play();
                playPauseBtn.textContent = '‚è∏Ô∏è Pause';
                logOperationalEvent("Video Playback Started");
            } else {
                videoPlayer.pause();
                playPauseBtn.textContent = '‚ñ∂Ô∏è Play';
                logOperationalEvent("Video Playback Paused");
            }
            isPaused = !isPaused;
        }

        /**
         * Rewinds the video by 10 seconds.
         */
        function rewindMedia() {
            if (videoPlayer.classList.contains('hidden')) return;
            videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10);
            logOperationalEvent("Video Rewind 10s");
        }

        /**
         * Fast Forwards the video by 10 seconds.
         */
        function ffMedia() {
            if (videoPlayer.classList.contains('hidden')) return;
            videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 10);
            logOperationalEvent("Video FF 10s");
        }

        /**
         * Toggles the view mode (e.g., full screen image vs. scrolled image).
         */
        function toggleView() {
            if (staticImage.classList.contains('hidden')) return; // Only for image viewer

            if (currentViewMode === 'default') {
                staticImage.style.maxHeight = '100vh'; // Full screen
                toggleViewBtn.textContent = 'Minimize';
                currentViewMode = 'full-screen';
                logOperationalEvent("Image Viewer: Full Screen Mode");
            } else {
                staticImage.style.maxHeight = '80vh'; // Constrained view
                toggleViewBtn.textContent = 'üîÑ View';
                currentViewMode = 'default';
                logOperationalEvent("Image Viewer: Default Mode");
            }
        }

        // =================================================================
        // INITIALIZATION
        // =================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Phase J Initialization: Set initial status
            updateIdentityStatus(); 

            // 1. Initial Data Setup (Attach event listeners to icons)
            document.querySelectorAll('.media-activator-icon').forEach(iconLink => {
                iconLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    const title = iconLink.getAttribute('data-lesson-title');
                    const path = iconLink.getAttribute('data-path');
                    const type = iconLink.getAttribute('data-type');

                    if (title && path && type) {
                        loadMediaPlayer(title, path, type);
                    } else {
                        alert('Lesson data is incomplete for this icon.');
                    }
                });
            });


            // 2. Control Bar Event Listeners
            if (playPauseBtn) playPauseBtn.onclick = togglePlayPause;
            if (rewindBtn) rewindBtn.onclick = rewindMedia;
            if (ffBtn) ffBtn.onclick = ffMedia;
            if (toggleViewBtn) toggleViewBtn.onclick = toggleView;
            if (stopBtn) stopBtn.onclick = wipePlayer;
            if (returnMenuBtn) returnMenuBtn.onclick = wipePlayer;


            // Add scroll event listener to the main index list
            if (lessonIndexList) {
                lessonIndexList.addEventListener('scroll', () => {
                    placeMarkerBtn.classList.remove('hidden');
                    // Ensure the marker button is set to save scroll position
                    placeMarkerBtn.textContent = 'üìå Save Marker';
                    placeMarkerBtn.onclick = savePlaceMarker;
                    // Prepare the lastMarker for a scroll save
                    lastMarker = {
                        userId: currentUserId,
                        lessonTitle: 'Index Scroll Position',
                        scrollPosition: lessonIndexList.scrollTop,
                        mediaPath: null,
                        mediaType: 'scroll'
                    };
                });
            }

            // Attempt to load the last marker on start (ONETH: Resume Session)
            loadPlaceMarker(); 
        });
    </script>
</body>
</html>
